---
title: "Code"
output: html_document
date: "2025-06-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(purrr)
source("Functions.R")
```

## Bayesian




```{r}

library(mvtnorm)


n <- 264
lambda <- 0.5
tau <- 0.5
sigma <- 25
n_sim <- 10^6





mus <- c(X = 12, Y = 2)

sigma_matrix <- matrix(c(25, 0.75*25, 0.75*25, 25), nrow = 2)


thetas <- rmvnorm(n_sim, mean = mus, sigma = sigma_matrix)

theta1 <- thetas[, 1]
theta2 <- thetas[, 2]



stage1 <- StageOne(n_sim, n, lambda, tau, sigma, theta1, theta2)

start_time <- Sys.time()

res <- optim(Utility_Optimise, 
       par = c(-1, 10), 
       n_sim = n_sim, 
       n = n, 
       lambda = lambda, 
       tau = tau, 
       sigma = sigma, 
       theta1 = theta1, 
       theta2 = theta2,
       stage1 = stage1,
       method = "BFGS",
       control = list(fnscale = -1))
end_time <- Sys.time()

df <- data.frame(
  a = res$par[1],
  b = res$par[2],
  utility = res$value
)

df

end_time - start_time




trial <- Trial(n_sim, n, lambda, tau, sigma, theta1, theta2, stage1, c(-0.5, 10))


trial %>%
  summarise(
    theta_3 = lambda * theta1 + (1 - lambda) * theta2,
    prob_only_H1 = round(mean(p1_c < 0.025 & p13_c < 0.025 & p3_c >= 0.025), 2),
    prob_only_H3 = round(mean(p3_c < 0.025 & p13_c < 0.025 & p1_c >= 0.025), 2),
    prob_only_Both = round(mean(p3_c < 0.025 & p13_c < 0.025 & p1_c < 0.025), 2),
    enrich = round(mean(enrich), 2)
  )


```









```{r}
max(replicate(100, Utility_Optimise(n_sim, n, lambda, tau, sigma, theta1, theta2, stage1, c(-0.5, 10))))
```










```{r}
a_vals <- seq(-2, 0, by = 0.1)
b_vals <- seq(14, 16, by = 0.1)
grid <- expand.grid(a = a_vals, b = b_vals)


grid$utility <- pmap_dbl(grid, function(a, b) {
  print(c(a,b))
  Utility_Optimise(n_sim, n, lambda, tau, sigma, theta1, theta2, stage1, c(a,b))
})

ggplot(grid, aes(x = a, y = b, z = utility)) +
  geom_contour_filled() +
  theme_minimal() +
  labs(title = "Plot of Expected Gain with prior values mu1 = 12, mu2 = 2",
       x = "Slope (a)", y = "Intercept (b)",
       fill = "Expected Gain")
```







